name: Build

on:
  push:
    branches: [main]

jobs:
  test-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest' # for Arm based macs (M1 and above).
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-15-intel' # for Intel based macs.
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-latest'
            args: ''
          - platform: 'windows-latest'
            args: ''
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup bun
        uses: oven-sh/setup-bun@v2

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ (matrix.platform == 'macos-14' || matrix.platform == 'macos-13') && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libxml2-dev

      - name: install dependencies (macos only)
        if: matrix.platform == 'macos-15-intel' || matrix.platform == 'macos-latest'
        run: |
          brew install libxml2
          echo "PKG_CONFIG_PATH=$(brew --prefix libxml2)/lib/pkgconfig" >> $GITHUB_ENV

      - name: install dependencies (windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          vcpkg integrate install
          vcpkg install libxml2:x64-windows-static-md
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV
          $vcpkgInstalled = "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows-static-md"
          echo "LIBXML2_DIR=$vcpkgInstalled" >> $env:GITHUB_ENV
          # Set linker search paths for MSVC
          echo "LIB=$vcpkgInstalled\lib;$env:LIB" >> $env:GITHUB_ENV
          echo "INCLUDE=$vcpkgInstalled\include;$vcpkgInstalled\include\libxml2;$env:INCLUDE" >> $env:GITHUB_ENV
          # Also set for pkg-config style discovery
          echo "LIBXML2_INCLUDE_DIR=$vcpkgInstalled\include\libxml2" >> $env:GITHUB_ENV
          echo "LIBXML2_LIB_DIR=$vcpkgInstalled\lib" >> $env:GITHUB_ENV
          # Create xml2.lib alias if libxml2.lib exists (some crates expect this name)
          $libxml2Lib = "$vcpkgInstalled\lib\libxml2.lib"
          $xml2Lib = "$vcpkgInstalled\lib\xml2.lib"
          if ((Test-Path $libxml2Lib) -and -not (Test-Path $xml2Lib)) {
            Copy-Item $libxml2Lib $xml2Lib
            Write-Host "Created xml2.lib alias"
          }
          # Find Windows SDK and MSVC paths for bindgen/clang
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
          $msvcPath = Get-ChildItem "$vsPath\VC\Tools\MSVC" | Sort-Object Name -Descending | Select-Object -First 1
          $msvcInclude = "$($msvcPath.FullName)\include"
          # Find Windows SDK
          $sdkVersion = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include" | Where-Object { $_.Name -match '^\d+\.' } | Sort-Object Name -Descending | Select-Object -First 1
          $sdkInclude = "C:\Program Files (x86)\Windows Kits\10\Include\$($sdkVersion.Name)\ucrt"
          # Set bindgen clang args to find system headers
          $clangArgs = "-I`"$msvcInclude`" -I`"$sdkInclude`" -I`"$vcpkgInstalled\include`" -I`"$vcpkgInstalled\include\libxml2`""
          echo "BINDGEN_EXTRA_CLANG_ARGS=$clangArgs" >> $env:GITHUB_ENV
          Write-Host "MSVC include: $msvcInclude"
          Write-Host "SDK include: $sdkInclude"
          Write-Host "Clang args: $clangArgs"
          # List what was installed for debugging
          Write-Host "Installed libraries:"
          Get-ChildItem "$vcpkgInstalled\lib\*.lib" | ForEach-Object { Write-Host $_.Name }
        shell: pwsh

      - name: install frontend dependencies
        run: bun install
       # If tagName and releaseId are omitted tauri-action will only build the app and won't try to upload any assets.
      - uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          tagName: nightly # the action automatically replaces \_\_VERSION\_\_ with the app version.
          releaseName: 'Saga-Scribe Nightly'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: true
          args: ${{ matrix.args }}

      # Upload Linux binary as artifact for Flatpak build
      - name: Upload Linux binary for Flatpak
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary-nightly
          path: src-tauri/target/release/saga-scribe
          retention-days: 1

  build-flatpak:
    needs: test-tauri
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-49
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-binary-nightly
          path: flatpak-build

      - name: Prepare Flatpak build directory
        run: |
          # Make binary executable
          chmod +x flatpak-build/saga-scribe

          # Copy resource directories
          cp -r static/entities flatpak-build/
          cp -r static/normalizer flatpak-build/
          cp -r static/dictionary flatpak-build/
          cp -r static/schemas flatpak-build/

          # Copy Flatpak metadata files
          cp flatpak/app.sagascribe.Sagascribe.desktop flatpak-build/
          cp flatpak/app.sagascribe.Sagascribe.metainfo.xml flatpak-build/
          cp flatpak/saga-scribe-wrapper.sh flatpak-build/

          # Copy icons
          cp src-tauri/icons/icon.png flatpak-build/icon-512.png
          cp src-tauri/icons/128x128@2x.png flatpak-build/icon-256.png
          cp src-tauri/icons/128x128.png flatpak-build/icon-128.png

          # Copy and use the CI-specific manifest
          cp flatpak/app.sagascribe.Sagascribe.ci.yml flatpak-build/app.sagascribe.Sagascribe.yml

          ls -la flatpak-build/

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: flatpak-build/app.sagascribe.Sagascribe.yml
          bundle: saga-scribe-nightly.flatpak
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak to Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          files: saga-scribe-nightly.flatpak
          token: ${{ secrets.PAT_TOKEN }}
