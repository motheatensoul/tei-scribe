name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog since $PREV_TAG"
            CHANGELOG=$(git log ${PREV_TAG}..
            --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Write to file for multi-line output
          echo "$CHANGELOG" > changelog.txt
          echo "changelog_file=changelog.txt" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          tag_name: ${{ inputs.version }}
          release_name: Saga-Scribe ${{ inputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: ${{ inputs.prerelease }}

  build-release:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            artifact_suffix: 'macos-arm64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            artifact_suffix: 'macos-x64'
          - platform: 'ubuntu-latest'
            args: ''
            artifact_suffix: 'linux-x64'
          - platform: 'windows-latest'
            args: ''
            artifact_suffix: 'windows-x64'
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libxml2-dev

      - name: Install dependencies (macos only)
        if: matrix.platform == 'macos-latest'
        run: |
          brew install libxml2
          echo "PKG_CONFIG_PATH=$(brew --prefix libxml2)/lib/pkgconfig" >> $GITHUB_ENV

      - name: Install dependencies (windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          vcpkg integrate install
          vcpkg install libxml2:x64-windows-static-md
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV
          $vcpkgInstalled = "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows-static-md"
          echo "LIBXML2_DIR=$vcpkgInstalled" >> $env:GITHUB_ENV
          # Set linker search paths for MSVC
          echo "LIB=$vcpkgInstalled\lib;$env:LIB" >> $env:GITHUB_ENV
          echo "INCLUDE=$vcpkgInstalled\include;$vcpkgInstalled\include\libxml2;$env:INCLUDE" >> $env:GITHUB_ENV
          # Also set for pkg-config style discovery
          echo "LIBXML2_INCLUDE_DIR=$vcpkgInstalled\include\libxml2" >> $env:GITHUB_ENV
          echo "LIBXML2_LIB_DIR=$vcpkgInstalled\lib" >> $env:GITHUB_ENV
          # Create xml2.lib alias if libxml2.lib exists (some crates expect this name)
          $libxml2Lib = "$vcpkgInstalled\lib\libxml2.lib"
          $xml2Lib = "$vcpkgInstalled\lib\xml2.lib"
          if ((Test-Path $libxml2Lib) -and -not (Test-Path $xml2Lib)) {
            Copy-Item $libxml2Lib $xml2Lib
            Write-Host "Created xml2.lib alias"
          }
          # Find Windows SDK and MSVC paths for bindgen/clang
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
          $msvcPath = Get-ChildItem "$vsPath\VC\Tools\MSVC" | Sort-Object Name -Descending | Select-Object -First 1
          $msvcInclude = "$($msvcPath.FullName)\include"
          # Find Windows SDK
          $sdkVersion = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include" | Where-Object { $_.Name -match '^\d+\.' } | Sort-Object Name -Descending | Select-Object -First 1
          $sdkInclude = "C:\Program Files (x86)\Windows Kits\10\Include\$($sdkVersion.Name)\ucrt"
          # Set bindgen clang args to find system headers
          $clangArgs = "-I`"$msvcInclude`" -I`"$sdkInclude`" -I`"$vcpkgInstalled\include`" -I`"$vcpkgInstalled\include\libxml2`""
          echo "BINDGEN_EXTRA_CLANG_ARGS=$clangArgs" >> $env:GITHUB_ENV
          Write-Host "MSVC include: $msvcInclude"
          Write-Host "SDK include: $sdkInclude"
          Write-Host "Clang args: $clangArgs"
          # List what was installed for debugging
          Write-Host "Installed libraries:"
          Get-ChildItem "$vcpkgInstalled\lib\*.lib" | ForEach-Object { Write-Host $_.Name }
        shell: pwsh

      - name: Install frontend dependencies
        run: bun install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

      # Upload Linux binary as artifact for Flatpak build
      - name: Upload Linux binary for Flatpak
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: src-tauri/target/release/saga-scribe
          retention-days: 1

  build-flatpak:
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-49
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: flatpak-build

      - name: Prepare Flatpak build directory
        run: |
          # Make binary executable
          chmod +x flatpak-build/saga-scribe

          # Copy resource directories
          cp -r static/entities flatpak-build/
          cp -r static/normalizer flatpak-build/
          cp -r static/dictionary flatpak-build/
          cp -r static/schemas flatpak-build/

          # Copy Flatpak metadata files
          cp flatpak/app.sagascribe.Sagascribe.desktop flatpak-build/
          cp flatpak/app.sagascribe.Sagascribe.metainfo.xml flatpak-build/
          cp flatpak/saga-scribe-wrapper.sh flatpak-build/

          # Copy icons
          cp src-tauri/icons/icon.png flatpak-build/icon-512.png
          cp src-tauri/icons/128x128@2x.png flatpak-build/icon-256.png
          cp src-tauri/icons/128x128.png flatpak-build/icon-128.png

          # Copy and use the CI-specific manifest
          cp flatpak/app.sagascribe.Sagascribe.ci.yml flatpak-build/app.sagascribe.Sagascribe.yml

          ls -la flatpak-build/

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: flatpak-build/app.sagascribe.Sagascribe.yml
          bundle: saga-scribe.flatpak
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: saga-scribe.flatpak
          asset_name: saga-scribe-${{ inputs.version }}-linux-x64.flatpak
          asset_content_type: application/octet-stream
